<%= title l(:label_issue_new) %>

<%= call_hook(:view_issues_new_top, {:issue => @issue}) %>

<%= labelled_form_for @issue, #:url => project_issues_path(@project),
                      :html => {:id => 'issue-form', :multipart => true} do |f| %>
    <%= error_messages_for 'issue' %>
    <%= hidden_field_tag 'copy_from', params[:copy_from] if params[:copy_from] %>

    <div class="box tabular">
      <div id="all_attributes">
        <%= render :partial => 'issues/form', :locals => {:f => f} %>
      </div>
      <!-- Listado de miembros seleccionados para propagarles issue: -->
      <!-- AVERIGUAR CÓMO ASIGNAR ISSUE AL SUBPROYECTO DEL MIEMBRO IMPLICADO (CAMBIAR PROPIEDAD DE LA ISSUE PARA QUE SE ENVIE A SUBPROYECTO DE USUARIO EN CUESTIÓN) -->
      <div class="splitcontentteaching">
        <div class="splitcontentteachingleft">
          <% if @issue.safe_attribute? 'assigned_to_id' %>
              <% select_options = principals_options_for_selection(@issue.assignable_users_subprojects, @issue.assigned_to) %>
            <p>
              <%= f.select :assigned_to_id, select_options, {:required => @issue.required_attribute?('assigned_to_id'), :include_blank => true, :label => l('assigned_students')},
                  {:multiple => true} %>
              <%= render 'projects_students_list' %>
            </p>
          <% end %>
          <!-- SE PUEDE ASIGNAR ISSUE A SUBPROYECTO (DESDE EL PROYECTO PRINCIPAL). DICHA ISSUE PUEDE SER MODIFICADA
       POR EL MIEMBRO DEL SUBPROYECTO, SIN NECESIDAD DE ASIGNARLE LA ISSUE. VERIFICAR POR QUÉ (REVISAR MODELO ISSUE): -->
          <!-- VALORAR SIGUIENTE FUNCIONALIDAD: AL SELECCIONAR UN MIEMBRO DE SUBPROYECTO, SE AUTOSELECCIONA SU SUBPROYECTO
           CORRESPONDIENTE. DE ESTE MODO, SE GENERA ISSUE EN DICHA DUPLA SUBPROYECTO/MIEMBRO-->
          <p>
            <% select_options = project_tree_options_for_select([@issue.project] | @issue.project.descendants, :selected => @issue.project) %>
            <%= f.select :project_id, select_options, {:required => false, :include_blank => true},
                         :onchange => "updateIssueFrom('#{escape_javascript project_issue_form_path(@project, :id => @issue, :format => 'js')}')" %>
          </p>
        </div>
      </div>

      <% if @copy_from && @copy_from.attachments.any? %>
          <p>
            <label for="copy_attachments"><%= l(:label_copy_attachments) %></label>
            <%= check_box_tag 'copy_attachments', '1', @copy_attachments %>
          </p>
      <% end %>
      <% if @copy_from && !@copy_from.leaf? %>
          <p>
            <label for="copy_subtasks"><%= l(:label_copy_subtasks) %></label>
            <%= check_box_tag 'copy_subtasks', '1', @copy_subtasks %>
          </p>
      <% end %>

      <p id="attachments_form"><label><%= l(:label_attachment_plural) %></label><%= render :partial => 'attachments/form', :locals => {:container => @issue} %></p>

      <% if @issue.safe_attribute? 'watcher_user_ids' -%>
          <p id="watchers_form"><label><%= l(:label_issue_watchers) %></label>
    <span id="watchers_inputs">
      <%= watchers_checkboxes(@issue, @available_watchers) %>
    </span>
    <span class="search_for_watchers">
    <%= link_to l(:label_search_for_watchers),
                {:controller => 'watchers', :action => 'new', :project_id => @issue.project},
                :remote => true,
                :method => 'get' %>
    </span>
          </p>
      <% end %>
    </div>

    <%= submit_tag l(:button_create) %>
    <%= submit_tag l(:button_create_and_continue), :name => 'continue' %>
    <%= preview_link preview_new_issue_path(:project_id => @project), 'issue-form' %>
    <!-- Enlace para abrir la ventana de diálogo (showModal()) donde se mostrará la selección de proyectos  -->
    <!-- Se genera la ruta de la issue en cuestión (...selection_path(id)) al pinchar en el enlace, para identificar sobre qué proyecto se está operando:  -->
    <% if @issue.project.descendants.any? && User.current.admin %>
      <%= link_to l("button_propagate"), plugin_teaching_extension_load_students_selection_path(:issue_id => @issue.id, :project_id => @issue.project.id), remote: true, id: "loadModalStudentsSelection", class: "load-modal-students-selection" %>
      <%#= link_to l("button_create_propagate"), '#', :onclick => 'showModal("ajax-modal", "1000px");$("#button_apply_projects").focus();' %>
    <% end %>
<% end %>

<script>
  $("#loadModalStudentsSelection").click(function(e) {
    var ids = $('#issue_assigned_to_id').val();
    if(ids==null) {
      ids=''
    }
    var sep = ($(this).attr('href').indexOf('?') != -1) ? '&' : '?';
    $(this).attr('href', $(this).attr('href') + sep + 'assigned_to_ids=' + ids );
  });
</script>

<div id="preview" class="wiki"></div>

<% content_for :header_tags do %>
    <%= robot_exclusion_tag %>
<% end %>
